<!DOCTYPE html>
<html>
<head>
    <title>Optimal Site Selection GIS</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            background: #f4f6fa;
            box-sizing: border-box;
        }
        #map {
            width: 100vw;
            height: calc(100vh - 80px);
        }
        .header-title {
            width: 100vw;
            background: linear-gradient(90deg, #1976d2 60%, #43a047 100%);
            color: #fff;
            font-size: 1.3rem;
            font-weight: 800;
            letter-spacing: 1.2px;
            text-align: center;
            padding: 10px 0 7px 0;
            margin: 0;
            box-shadow: 0 2px 12px rgba(25,118,210,0.10);
            border-radius: 0 0 18px 18px;
        }
        .topbar {
            width: 100vw;
            z-index: 1000;
            background: rgba(255,255,255,0.97);
            border-radius: 0 0 16px 16px;
            box-shadow: 0 8px 32px rgba(44,62,80,0.13), 0 1.5px 6px rgba(44,62,80,0.06);
            padding: 16px 28px 12px 28px;
            border-bottom: 1.5px solid #e3e7ee;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 24px;
            transition: box-shadow 0.2s;
        }
        .topbar-section {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            background: rgba(245,247,250,0.7);
            border-radius: 10px;
            padding: 10px 18px;
            margin-right: 12px;
            box-shadow: 0 1px 4px rgba(44,62,80,0.03);
        }
        .topbar-section:not(:last-child) {
            border-right: 1px solid #e3e7ee;
        }
        .topbar label, .topbar select, .topbar input {
            font-size: 1rem;
        }
        .topbar button {
            background: linear-gradient(90deg, #1976d2 60%, #43a047 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 18px;
            font-size: 1rem;
            margin-top: 0;
            margin-bottom: 0;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(25,118,210,0.08);
        }
        .topbar button:hover {
            background: linear-gradient(90deg, #1565c0 60%, #388e3c 100%);
            box-shadow: 0 2px 8px rgba(25,118,210,0.10);
        }
        .topbar input, .topbar select {
            border: 1px solid #cfd8dc;
            border-radius: 6px;
            padding: 6px 10px;
            margin: 0 4px 0 0;
        }
        .topbar strong {
            color: #2d3a4a;
            font-size: 1.08rem;
            margin-right: 8px;
        }
        .topbar input[type="checkbox"] {
            accent-color: #1976d2;
        }
        @media (max-width: 1100px) {
            .topbar {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 10px 2vw 6px 2vw;
            }
            .topbar-section {
                margin-bottom: 8px;
                border-right: none !important;
            }
        }
        @media (max-width: 700px) {
            .header-title {
                font-size: 1.2rem;
                padding: 12px 0 8px 0;
                border-radius: 0 0 16px 16px;
            }
            .topbar {
                padding: 8px 2vw 4px 2vw;
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            .topbar-section {
                margin-bottom: 6px;
                border-right: none !important;
            }
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .topbar-section.overlay-section {
            border-left: 1.5px solid #e3e7ee;
            margin-left: 10px;
            padding-left: 10px;
            background: rgba(230,245,255,0.4);
        }
        .attribute-query-bar {
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.98);
            box-shadow: 0 2px 8px rgba(44,62,80,0.07);
            border-radius: 0 0 16px 16px;
            padding: 18px 0 12px 0;
            margin: 0;
            position: relative;
            z-index: 900;
        }
        .attribute-query-inner {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(245,247,250,0.7);
            border-radius: 10px;
            padding: 10px 18px;
            box-shadow: 0 1px 4px rgba(44,62,80,0.03);
        }
        .attribute-query-inner strong {
            color: #2d3a4a;
            font-size: 1.08rem;
            margin-right: 8px;
        }
        .attribute-query-inner label, .attribute-query-inner select, .attribute-query-inner input {
            font-size: 1rem;
        }
        .attribute-query-inner button {
            background: linear-gradient(90deg, #1976d2 60%, #43a047 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 8px 18px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(25,118,210,0.08);
        }
        .attribute-query-inner button:hover {
            background: linear-gradient(90deg, #1565c0 60%, #388e3c 100%);
            box-shadow: 0 4px 16px rgba(25,118,210,0.12);
        }
        .attribute-query-inner input, .attribute-query-inner select {
            border: 1px solid #cfd8dc;
            border-radius: 6px;
            padding: 6px 10px;
            margin: 0 4px 0 0;
        }
        .overlay-layers-bar {
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.98);
            box-shadow: 0 2px 8px rgba(44,62,80,0.07);
            border-radius: 0 0 16px 16px;
            padding: 18px 0 12px 0;
            margin: 0;
            position: relative;
            z-index: 850;
        }
        .overlay-layers-inner {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(230,245,255,0.4);
            border-radius: 10px;
            padding: 10px 18px;
            box-shadow: 0 1px 4px rgba(44,62,80,0.03);
        }
        .overlay-layers-inner strong {
            color: #2d3a4a;
            font-size: 1.08rem;
            margin-right: 8px;
        }
        .overlay-layers-inner label {
            font-size: 1rem;
        }
        .overlay-layers-inner input[type="checkbox"] {
            accent-color: #1976d2;
        }
        .topbar-section.data-layers, .topbar-section.buffer-section {
            background: #f5faff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(44,62,80,0.04);
            padding: 12px 20px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .topbar-section.data-layers strong, .topbar-section.buffer-section strong {
            display: flex;
            align-items: center;
            font-size: 1.08rem;
            color: #1976d2;
            margin-right: 10px;
        }
        .topbar-section.data-layers strong::before {
            content: '\1F5FA'; /* map icon */
            font-size: 1.2em;
            margin-right: 6px;
        }
        .topbar-section.buffer-section strong::before {
            content: '\1F50D'; /* magnifier icon */
            font-size: 1.2em;
            margin-right: 6px;
        }
        .topbar-section.data-layers button {
            margin-right: 4px;
            padding: 4px 10px;
            font-size: 0.92rem;
            border-radius: 6px;
            min-width: 0;
            height: 28px;
        }
        .topbar-section.buffer-section {
            background: #f5faff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(44,62,80,0.04);
            padding: 8px 10px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .topbar-section.buffer-section label {
            margin-right: 2px;
            white-space: nowrap;
        }
        .topbar-section.buffer-section input[type="number"] {
            max-width: 90px;
            min-width: 60px;
            padding: 4px 6px;
            font-size: 0.98rem;
        }
        .topbar-section.buffer-section button {
            margin-left: 0;
            margin-right: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(90deg, #43a047 60%, #1976d2 100%);
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(67,160,71,0.10);
            padding: 6px 12px;
            font-size: 0.98rem;
        }
        @media (max-width: 900px) {
            .topbar-section.buffer-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            .topbar-section.buffer-section button {
                width: 100%;
                margin-top: 4px;
            }
        }
    </style>
</head>
<body>
    <div class="header-title">Optimal Site Selection GIS</div>
    <div class="topbar">
        <div class="topbar-section data-layers">
            <strong>Data Layers</strong>
            <button onclick="loadLayer('landuse')">Land Use</button>
            <button onclick="loadLayer('nepal population density')">Population Density</button>
            <button onclick="loadLayer('roads')">Roads</button>
        </div>
        <div class="topbar-section buffer-section">
            <strong>Buffer & Intersect</strong>
            <label>Road ID: <input type="number" id="roadId" value="1" min="1"></label>
            <label>Distance (m): <input type="number" id="bufferDist" value="500" min="1"></label>
            <button onclick="bufferRoad()">Buffer & Intersect</button>
        </div>
    </div>
    <div class="attribute-query-bar">
        <div class="attribute-query-inner">
            <strong>Attribute Query</strong>
            <label>Layer:
                <select id="attrLayer">
                    <option value="landuse">Land Use</option>
                    <option value="nepal_population_density">Population Density</option>
                </select>
            </label>
            <input id="attrField" placeholder="Attribute (e.g., type, density)">
            <select id="attrOp">
                <option value="=">=</option>
                <option value=">">></option>
                <option value="<"><</option>
                <option value="LIKE">Contains</option>
            </select>
            <input id="attrVal" placeholder="Value">
            <button onclick="attributeQuery()">Query</button>
        </div>
    </div>
    <div class="overlay-layers-bar">
        <div class="overlay-layers-inner">
            <strong>Overlay Layers</strong>
            <label><input type="checkbox" id="localLevelLayer" onchange="toggleOverlay('locallevel')"> Local Level</label>
            <label><input type="checkbox" id="districtLayer" onchange="toggleOverlay('district')"> District</label>
            <label><input type="checkbox" id="provinceLayer" onchange="toggleOverlay('province')"> Province</label>
        </div>
    </div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let map = L.map('map', { zoomControl: true }).setView([27.7, 85.3], 10);

        // Base maps
        const baseMaps = {
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM contributors' }),
            "CartoDB Positron": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CartoDB' }),
            "Esri World Imagery": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' })
        };
        baseMaps["OpenStreetMap"].addTo(map);

        // Overlay layers
        let overlays = {
            "Local Level": null,
            "District": null,
            "Province": null
        };

        // Layer control
        let layerControl = L.control.layers(baseMaps, {}, { position: 'topright' }).addTo(map);

        // Overlay fetch and toggle logic
        function toggleOverlay(type) {
            const layerNames = {
                locallevel: "Local Level",
                district: "District",
                province: "Province"
            };
            if (overlays[layerNames[type]]) {
                map.removeLayer(overlays[layerNames[type]]);
                overlays[layerNames[type]] = null;
                layerControl.removeLayer(overlays[layerNames[type]]);
            } else {
                let url = '';
                if (type === 'district') {
                    url = 'http://localhost:5000/layers/nepal_administrative_boundary';
                } else {
                    url = `http://localhost:5000/layers/${type}`;
                }
                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        const style = {
                            locallevel: { color: '#43a047', weight: 1, fillOpacity: 0.1 },
                            district: { color: '#1e88e5', weight: 2, fillOpacity: 0.05 },
                            province: { color: '#fbc02d', weight: 3, fillOpacity: 0.03 }
                        };
                        overlays[layerNames[type]] = L.geoJSON(data, { style: style[type] });
                        overlays[layerNames[type]].addTo(map);
                        layerControl.addOverlay(overlays[layerNames[type]], layerNames[type]);
                    });
            }
        }

        let overlayLayer;

        function loadLayer(layer) {
            fetch(`http://localhost:5000/layers/${layer}`)
                .then(res => res.json())
                .then(data => {
                    if (overlayLayer) map.removeLayer(overlayLayer);
                    overlayLayer = L.geoJSON(data, {
                        onEachFeature: function (feature, layer) {
                            layer.bindPopup(JSON.stringify(feature.properties));
                        }
                    }).addTo(map);
                    if (overlayLayer.getBounds().isValid()) map.fitBounds(overlayLayer.getBounds());
                });
        }

        function bufferRoad() {
            let roadId = document.getElementById('roadId').value;
            let bufferDist = document.getElementById('bufferDist').value;
            fetch('http://localhost:5000/spatial/buffer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: roadId, distance: bufferDist})
            })
            .then(res => res.json())
            .then(bufferFeature => {
                if (overlayLayer) map.removeLayer(overlayLayer);
                overlayLayer = L.geoJSON(bufferFeature, {style: {color: 'red'}}).addTo(map);
                map.fitBounds(overlayLayer.getBounds());
                // Intersect with landuse
                fetch('http://localhost:5000/spatial/intersect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({buffer_geom: bufferFeature.geometry})
                })
                .then(res => res.json())
                .then(intersectData => {
                    L.geoJSON(intersectData, {style: {color: 'blue', fillOpacity: 0.3}}).addTo(map);
                });
            });
        }

        function attributeQuery() {
            let layer = document.getElementById('attrLayer').value;
            let attr = document.getElementById('attrField').value;
            let op = document.getElementById('attrOp').value;
            let val = document.getElementById('attrVal').value;
            fetch(`http://localhost:5000/attribute/query?layer=${layer}&attr=${attr}&op=${op}&val=${encodeURIComponent(val)}`)
                .then(res => res.json())
                .then(data => {
                    if (overlayLayer) map.removeLayer(overlayLayer);
                    overlayLayer = L.geoJSON(data, {
                        onEachFeature: function (feature, layer) {
                            layer.bindPopup(JSON.stringify(feature.properties));
                        }
                    }).addTo(map);
                    if (overlayLayer.getBounds().isValid()) map.fitBounds(overlayLayer.getBounds());
                });
        }

        // Adjust map height on resize to always fill below the header, topbar, attribute query bar, and overlay layers bar
        function resizeMap() {
            const header = document.querySelector('.header-title');
            const topbar = document.querySelector('.topbar');
            const attrBar = document.querySelector('.attribute-query-bar');
            const overlayBar = document.querySelector('.overlay-layers-bar');
            const mapDiv = document.getElementById('map');
            const headerHeight = header.offsetHeight;
            const topbarHeight = topbar.offsetHeight;
            const attrBarHeight = attrBar.offsetHeight;
            const overlayBarHeight = overlayBar.offsetHeight;
            mapDiv.style.height = `calc(100vh - ${headerHeight + topbarHeight + attrBarHeight + overlayBarHeight}px)`;
        }
        window.addEventListener('resize', resizeMap);
        window.addEventListener('DOMContentLoaded', resizeMap);
    </script>
</body>
</html>
